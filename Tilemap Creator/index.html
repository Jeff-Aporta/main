<!DOCTYPE html>
<html lang="es">

<head>
     <meta charset="UTF-8">
     <meta http-equiv="X-UA-Compatible" content="IE=edge">
     <meta name="viewport" content="width=device-width, initial-scale=1.0">
     <title>Tilemap creator</title>

     <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css">
     <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

</head>

<body>
     <style>
          body {
               background: steelblue;
          }

          input[type="text"],
          input[type="number"] {
               width: 90px;
               text-align: center;
               margin: 3px;
               padding: 5px;
          }

          .prev {
               width: 50px;
               height: 50px;
               border: 1px solid black;
               display: inline-block;
               margin: 3px;
          }

          #previsualización td {
               border: 1px solid black;
          }

          table {
               margin: 10px;
               border: 1px solid black;
               display: inline-block;
               background: rgba(255, 255, 255, 0.5);
          }

          textarea {
               padding: 10px;
          }

          #guia td {
               padding: 5px;
          }
     </style>
     <table cellspacing="0" cellpadding="0">
          <tbody>
               <tr>
                    <td colspan="2" id="settings" style="text-align:center;">
                         <table cellspacing="0" cellpadding="0">
                              <thead>
                                   <tr>
                                        <th>
                                             Columnas
                                        </th>
                                        <th>
                                             Filas
                                        </th>
                                        <th>
                                             Lado
                                        </th>
                                        <th>
                                             Lozas
                                        </th>
                                   </tr>
                              </thead>
                              <tbody>
                                   <tr>
                                        <td>
                                             <input type="number" id="columnas" value="10" max="500" min="1"
                                                  onchange="generarCuadriculaDiseño()">
                                        </td>
                                        <td>
                                             <input type="number" id="filas" value="10" max="500" min="1"
                                                  onchange="generarCuadriculaDiseño()">
                                        </td>
                                        <td>
                                             <input type="number" id="lado" value="30" min="5" max="100"
                                                  onchange="generarCuadriculaDiseño()">
                                        </td>
                                        <td>
                                             <input type="number" id="lozas" value="1" min="1" max="50"
                                                  onclick="generarRutas()">
                                        </td>
                                   </tr>
                              </tbody>
                         </table>
                    </td>
               </tr>
               <tr>
                    <td id="guia" style="text-align:center;">
                         <table cellspacing="0" cellpadding="0">
                              <tbody>
                                   <tr>
                                        <td id="rutas">
                                        </td>
                                   </tr>
                              </tbody>
                         </table>
                    </td>
               </tr>
               <tr>
                    <td style="text-align: center;">
                         <h5>Diseño</h5>
                         <label>
                              <input type="checkbox" id="mostrar-guias" checked onchange="generarCuadriculaDiseño()">
                              Mostrar Guias
                         </label>
                         <br>
                         <table cellspacing="0" cellpadding="0" id="previsualización">
                         </table>
                    </td>
               </tr>
               <tr>
                    <td>
                         <h5>Código de exportación <i class="fab fa-js"></i></h5>
                         <textarea id="export-code" style="width: 90%;" rows="10" readonly></textarea>
                    </td>
               </tr>
          </tbody>
     </table>

     <script>

          function ajustarDatosReal(id, max, def) {
               if (localStorage.getItem(id)) {
                    if (Number(localStorage.getItem(id)) > max) {
                         localStorage.setItem(id, max)
                    }
                    document.getElementById(id).value = localStorage.getItem(id)
               } else {
                    document.getElementById(id).value = def
               }
          }

          ajustarDatosReal("filas", 500, 50)
          ajustarDatosReal("columnas", 500, 50)
          ajustarDatosReal("lado", 100, 30)

          document.getElementById("lozas").value = localStorage.getItem("lozas") ?? 1

          generarCuadriculaDiseño()
          generarRutas()

          function generarCódigoDeExportación() {
               let rutas = localStorage.getItem("rutas") ?? []
               let matriz = localStorage.getItem("matriz") ?? []
               let retorno = {
                    rutas,
                    matriz
               }
               document.getElementById("export-code").value = JSON.stringify(retorno)
          }

          function generarRutas() {
               let lozas = Number(document.getElementById("lozas").value)
               localStorage.setItem("lozas", lozas)

               let rutas = JSON.parse(localStorage.getItem("rutas")) ?? []

               let html = ""
               for (let i = 0; i < lozas; i++) {
                    html += `
                         <div style="display: inline-block;text-align:center;">
                              Ruta:
                              <br>
                              <input type="text" id="loza-${i}" onchange="obtenerRutas();generarRutas();generarCuadriculaDiseño()" value="${rutas[i] ?? ""}">
                              <br>
                              ${i}
                              <br>
                              <div class="prev" style="background-image:url(${rutas[i] ?? ""});background-position: center;background-repeat: no-repeat;background-size: cover;">
                              </div>
                         </div>
                         `
               }
               document.getElementById("rutas").innerHTML = html
          }

          function obtenerRutas() {
               let lozas = Number(document.getElementById("lozas").value)
               let rutas = []
               for (let i = 0; i < lozas; i++) {
                    rutas.push(document.getElementById(`loza-${i}`).value)
               }
               localStorage.setItem("rutas", JSON.stringify(rutas, null, "\t"))
          }

          function obtenerMatrizMapa() {
               let matriz = []
               for (let fila = 0; fila < Number(localStorage.getItem("filas")); fila++) {
                    matriz.push([])
                    for (let columna = 0; columna < Number(localStorage.getItem("columnas")); columna++) {
                         let elemento = document.getElementById(`t-${columna}-${fila}`).innerHTML
                         matriz[fila][columna] = elemento
                    }
               }
               localStorage.setItem("matriz", JSON.stringify(matriz))
          }

          function selectElementContents(element) {
               var range = document.createRange();
               range.selectNodeContents(element);
               var sel = window.getSelection();
               sel.removeAllRanges();
               sel.addRange(range);
          }

          function generarCuadriculaDiseño() {
               let filas = Number(document.getElementById("filas").value)
               let columnas = Number(document.getElementById("columnas").value)
               let lado = Number(document.getElementById("lado").value)

               let matriz = JSON.parse(localStorage.getItem("matriz"))

               let rutas = JSON.parse(localStorage.getItem("rutas")) ?? []

               let mostrar_guias = document.getElementById("mostrar-guias").checked

               localStorage.setItem("filas", filas)
               localStorage.setItem("columnas", columnas)
               localStorage.setItem("lado", lado)

               html = `<tbody>`
               for (let fila = 0; fila < filas; fila++) {
                    html += `<tr>`
                    for (let columna = 0; columna < columnas; columna++) {
                         let index = matriz ? matriz[fila] ? matriz[fila][columna] ?? 0 : 0 : 0
                         html += `<td style="${mostrar_guias ? "" : `border: none;color:transparent;`}background-image:url(${rutas[index] ?? ""});background-position: center;background-repeat: no-repeat;background-size: cover;width:${lado}px;height:${lado}px" id="t-${columna}-${fila}" contenteditable="true" onfocus="selectElementContents(this)" title="(${columna},${fila})">`
                         html += index
                         html += `</td>`
                    }
                    html += `</tr>`
               }
               html += `</tbody>`

               document.getElementById("previsualización").innerHTML = html

               document.body.style.width = lado * columnas + 100 + "px"
               document.getElementById("previsualización").style.width = lado * columnas

               for (let fila = 0; fila < filas; fila++) {
                    for (let columna = 0; columna < columnas; columna++) {
                         document.getElementById(`t-${columna}-${fila}`).addEventListener("DOMCharacterDataModified", () => {
                              obtenerMatrizMapa()
                              generarCuadriculaDiseño()
                         })
                         document.getElementById(`t-${columna}-${fila}`).addEventListener("keydown", (evt) => {
                              if (evt.keyCode < 48 || evt.keyCode > 57) {
                                   if (evt.keyCode != 8 && evt.keyCode != 9 && evt.keyCode != 46) {
                                        evt.preventDefault();
                                   }
                              }
                         })
                    }
               }
               generarCódigoDeExportación()
          }
     </script>
</body>

</html>