<!DOCTYPE html>
<html lang="en">

<head>
     <meta charset="UTF-8">
     <meta http-equiv="X-UA-Compatible" content="IE=edge">
     <meta name="viewport" content="width=device-width, initial-scale=1.0">
     <title>Document</title>
     <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.4.0/p5.min.js"></script>
     <script src="https://unpkg.com/h264-mp4-encoder/embuild/dist/h264-mp4-encoder.web.js"></script>
</head>

<body>
     <script>
          let inc = 0.01;

          const ancho = 400
          const alto = 400

          let recording = false
          let encoder

          function preload() {
               HME.createH264MP4Encoder().then(enc => {
                    encoder = enc
                    encoder.outputFilename = (random() + "").replace("0.", "JeffAporta")
                    encoder.width = ancho;
                    encoder.height = alto;
                    encoder.frameRate = 20
                    encoder.kbps = 50000
                    encoder.groupOfPictures = 10
                    encoder.initialize()
               })
          }

          function setup() {
               createCanvas(ancho, alto);
               pixelDensity(1);

               botón = createButton("Grabar")
               botón.mousePressed(() => {
                    recording = botón.html() == "Grabar"
                    if (recording) {
                         botón.html("Detener")
                    } else {
                         botón.html("Grabar")
                         finalizarGrabación()
                    }
               })
          }

          function draw() {
               let yoff = 0;
               loadPixels();
               noiseDetail(7, 0.65);
               for (let y = 0; y < height; y++) {
                    let xoff = 0;
                    for (let x = 0; x < width; x++) {
                         let index = (x + y * width) * 4;
                         let r = noise(xoff, yoff, frameCount / 20) ** 2;
                         let c = lerpColor(color("gold"), color("orangered"), r);
                         pixels[index + 0] = red(c);
                         pixels[index + 1] = green(c);
                         pixels[index + 2] = blue(c);
                         pixels[index + 3] = 255;
                         xoff += inc;
                    }
                    yoff += inc;
               }
               updatePixels();
               grabarFotograma()
          }

          function grabarFotograma() {
               if (recording) {
                    encoder.addFrameRgba(drawingContext.getImageData(0, 0, encoder.width, encoder.height).data)
               }
          }

          function finalizarGrabación() {
               recording = false
               encoder.finalize()
               const uint8Array = encoder.FS.readFile(encoder.outputFilename)
               const descargador = document.createElement("a")
               descargador.href = URL.createObjectURL(new Blob([uint8Array], { type: 'video/mp4' }))
               descargador.download = encoder.outputFilename
               descargador.click()
               encoder.delete()

               preload()
          }

     </script>
</body>

</html>